@model MODAMS.Models.ViewModels.Dto.TransferDTO

@using System.Globalization
@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["TourPageKey"] = "Transfers/Index";
    var isSomali = CultureInfo.CurrentUICulture.Name == "so";

    IEnumerable<SelectListItem> storesSelect = Model?.StoreList ?? Enumerable.Empty<SelectListItem>();
    var selectedStoreId = Model?.StoreId ?? 0;
    var selectedStoreName = Model?.SelectedStoreName ?? "Invalid Store";

    var kpiOutValue = Model?.TotalTransferValue ?? 0m;
    var kpiInValue = Model?.TotalReceivedValue ?? 0m;
    var kpiOutCount = Model?.TotalTransferCount(selectedStoreId);
    var kpiInCount = Model?.TotalReceivedCount(selectedStoreId);

    Func<int, string> BadgeByStatusId = id =>
    {
        switch (id)
        {
            case 1: return "info";   // Pending
            case 2: return "success";   // Awaiting Ack / Received (tune as needed)
            case 3: return "primary"; // Completed
            case 4: return "danger";    // Rejected
            default: return "info";
        }
    };

    Func<int, string> StatusText = id =>
    {
        return id switch
        {
            1 => isSomali ? "Sugaya" : "Pending",
            2 => isSomali ? "Sugaya Acknowledgement" : "Awaiting Acknowledgement",
            3 => isSomali ? "Dhammaystiran" : "Completed",
            4 => isSomali ? "La Diiday" : "Rejected",
            _ => isSomali ? "Aan La Garan" : "Unknown"
        };
    };
}
<link href="~/css/transfers-index.css" rel="stylesheet" />
<div class="page-header">
    <div>
        <h1 class="page-title" data-tour="tr.title">@Localizer["AssetTransfers"]</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb" data-tour="tr.breadcrumbs">
            <li class="breadcrumb-item">
                <a asp-area="Users" asp-controller="Home" asp-action="Index">@Localizer["Dashboard"]</a>
            </li>
            <li class="breadcrumb-item">
                <a asp-area="Users" asp-controller="Transfers" asp-action="Index">@Localizer["Transfers"]</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Localizer["Index"]</li>
        </ol>
    </div>
</div>

<!-- KPI / Summary -->
<div class="row g-3 align-items-stretch">
    <div class="col-md-4">
        <div class="card card-kpi card-kpi--out divShadow--xs h-100" data-tour="tr.kpi.out">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted mb-1">@Localizer["OutgoingTransfers"]</div>
                        <div class="metric fs-3">@kpiOutCount?.ToString("N0")</div>
                        <small class="text-muted">@Localizer["TotalValue"]: @kpiOutValue.ToString("N2")</small>
                    </div>
                    <i class="fe fe-log-out fs-2 text-primary"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi card-kpi--in divShadow--xs h-100" data-tour="tr.kpi.in">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-muted mb-1">@Localizer["IncomingTransfers"]</div>
                        <div class="metric fs-3">@kpiInCount?.ToString("N0")</div>
                        <small class="text-muted">@Localizer["TotalValue"]: @kpiInValue.ToString("N2")</small>
                    </div>
                    <i class="fe fe-log-in fs-2 text-success"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card card-kpi card-kpi--search divShadow--xs h-100" data-tour="tr.kpi.search">
            <div class="card-body d-flex flex-column">
                <label class="form-label mb-1">@Localizer["SearchTransferByAsset"]</label>
                <div class="input-group mb-1">
                    <input id="txtSearchTransferByAsset" type="text" class="form-control" placeholder="@Localizer["ScanOrTypeBarcode"]" />
                    <button id="btnSearchTransferByAsset" class="btn btn-outline-secondary">
                        <i class="fe fe-search"></i>
                    </button>
                </div>
                <small class="text-muted">@Localizer["HintTypeOrScanBarcode"]</small>
            </div>
        </div>
    </div>
</div>

<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body project-list-table-container">
                <!-- Toolbar -->
                <div class="toolbar d-flex align-items-center gap-2 flex-wrap mb-2" data-tour="tr.toolbar">

                    @if (Model?.IsAuthorized == true)
                    {
                        <a asp-area="Users" asp-controller="Transfers" asp-action="CreateTransfer"
                           class="btn btn-outline-info" data-tour="tr.create"
                           title="@Localizer["CreateNewTransfer"]">
                            <i class="fa fa-circle-plus" aria-hidden="true"></i>
                            <span>@Localizer["CreateTransfer"]</span>
                        </a>
                    }

                    <div class="filters-group d-flex align-items-center ms-auto gap-2 flex-wrap" data-tour="tr.filters">
                        <label class="mb-0 fw-semibold" data-tour="tr.filters.label">@Localizer["Filter"]:</label>

                        <!-- Store filter: fixed visual width; Select2 will respect it -->
                        <select id="ddStores"
                                class="form-select select2"
                                data-width="style"
                                style="width: 360px;"
                                data-tour="tr.filters.store"
                                asp-items="storesSelect">
                        </select>

                        <input id="dtFrom" type="text" class="form-control filter-input picker"
                               placeholder="@Localizer["From"]" data-tour="tr.filters.from" />
                        <input id="dtTo" type="text" class="form-control filter-input picker"
                               placeholder="@Localizer["To"]" data-tour="tr.filters.to" />

                        <button id="btnApplyFilters" class="btn btn-outline-primary flex-shrink-0" data-tour="tr.filters.apply">
                            <i class="fe fe-filter"></i> @Localizer["Apply"]
                        </button>
                    </div>
                </div>



                <!-- Outgoing -->
                <div class="mb-3">
                    <h5 class="mb-2" data-tour="tr.out.title">@Localizer["OutgoingFromStore"] (@selectedStoreName)</h5>
                    <div class="table-responsive export-table" data-tour="tr.out.wrap">
                        <table id="tblTransfersOut"
                               class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main"
                               data-tour="tr.out.table">
                            <thead class="bg-primary-gradient ms-auto divShadow" data-tour="tr.out.head">
                                <tr>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["TransferNo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Date"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["StoreTo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Assets"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Status"]</th>
                                </tr>
                            </thead>
                            <tbody class="table-body" data-tour="tr.out.body">
                                @if (Model?.OutgoingTransfers != null)
                                {
                                    foreach (var t in Model.OutgoingTransfers)
                                    {
                                        var statusId = t.TransferStatusId;
                                        var badge = BadgeByStatusId(statusId);
                                        var badgeBgClass = $"bg-{badge}-transparent";
                                        var badgeTextClass = $"text-{badge}";
                                        <tr data-id="@t.Id" data-status-id="@(t.TransferStatusId)">
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferNumber</td>
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferDate?.ToString("dd-MMM-yyyy")</td>
                                            <td class="text-muted fs-15 fw-semibold">@((isSomali ? t.StoreToSo : t.StoreTo) ?? "")</td>
                                            <td class="text-muted fs-15 fw-semibold">@Html.Raw(Model.GetAssetsBadges(t.Id))</td>
                                            <td class="text-muted fs-15 fw-semibold">
                                                <span class="mb-0 mt-1 badge rounded-pill @badgeBgClass @badgeTextClass">
                                                    @StatusText(statusId)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Incoming -->
                <div>
                    <h5 class="mb-2" data-tour="tr.in.title">@Localizer["IncomingToStore"] (@selectedStoreName)</h5>
                    <div class="table-responsive export-table" data-tour="tr.in.wrap">
                        <table id="tblTransfersIn"
                               class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main"
                               data-tour="tr.in.table">
                            <thead class="bg-primary-gradient ms-auto divShadow" data-tour="tr.in.head">
                                <tr>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["TransferNo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Date"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["StoreFrom"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Assets"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Status"]</th>
                                </tr>
                            </thead>
                            <tbody class="table-body" data-tour="tr.in.body">
                                @if (Model?.IncomingTransfers != null)
                                {
                                    foreach (var t in Model.IncomingTransfers)
                                    {
                                        var statusId = t.TransferStatusId;
                                        var badge = BadgeByStatusId(statusId);
                                        var badgeBgClass = $"bg-{badge}-transparent";
                                        var badgeTextClass = $"text-{badge}";
                                        <tr data-id="@t.Id" data-status-id="@(statusId)">
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferNumber</td>
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferDate?.ToString("dd-MMM-yyyy")</td>
                                            <td class="text-muted fs-15 fw-semibold">@((isSomali ? t.StoreFromSo : t.StoreFrom) ?? "")</td>
                                            <td class="text-muted fs-15 fw-semibold">@Html.Raw(Model.GetAssetsBadges(t.Id))</td>
                                            <td class="text-muted fs-15 fw-semibold">
                                                <span class="mb-0 mt-1 badge rounded-pill @badgeBgClass @badgeTextClass">
                                                    @StatusText(statusId)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <a asp-area="Users" asp-controller="Transfers" asp-action="Index" id="btnBack"
                           class="btn btn-outline-default" data-tour="tr.back">
                            <i class="fe fe-corner-up-left"></i>&nbsp;@Localizer["Previous"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@await Html.PartialAsync("~/Views/Shared/_Confirmation.cshtml")

@section scripts {

    <partial name="_DatatablesAssets" />

    <script>
        // Provide config for your hover-action logic in /js/pages/transfers-index.js
        window.TRANSFERS_PAGE = {
            isAuthorized: @Html.Raw((Model?.IsAuthorized ?? false).ToString().ToLowerInvariant()),
            strings: {
                previewTransfer: "@Localizer["PreviewTransfer"]",
                editTransfer: "@Localizer["EditTransfer"]",
                deleteTransfer: "@Localizer["DeleteTransfer"]",
                deleteConfirmationMessage: "@Localizer["DeleteConfirmationMessage"]",
                confirm: "@Localizer["Confirm"]",
                cancel: "@Localizer["Cancel"]",
                date: "@Localizer["Date"]",
                storeFrom: "@Localizer["FromStore"]",
                storeTo: "@Localizer["ToStore"]",
                assets: "@Localizer["Assets"]",
                status: "@Localizer["Status"]"
            }
        };
    </script>

    <script src="~/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="~/js/pages/transfers-index.js"></script>
}
