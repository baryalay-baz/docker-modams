@model MODAMS.Models.ViewModels.Dto.TransferDTO

@using System.Globalization
@using System.Linq
@using Microsoft.AspNetCore.Mvc.Rendering
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["TourPageKey"] = "Transfers/Index";
    var isSomali = CultureInfo.CurrentUICulture.Name == "so";

    IEnumerable<SelectListItem> storesSelect = Model?.StoreList ?? Enumerable.Empty<SelectListItem>();
    var selectedStoreId = Model?.StoreId ?? 0;
    var selectedStoreName = Model?.SelectedStoreName ?? "Invalid Store";

    var statusFilter = 3;

    var kpiOutCount = Model?.GetTransferCountOut(selectedStoreId, statusFilter) ?? 0;
    var kpiInCount = Model?.GetTransferCountIn(selectedStoreId, statusFilter) ?? 0;
    var kpiOutAssetsCount = Model?.GetAssetCountOut(selectedStoreId, statusFilter) ?? 0;
    var kpiInAssetsCount = Model?.GetAssetCountIn(selectedStoreId, statusFilter) ?? 0;

    Func<int, string> BadgeByStatusId = id =>
    {
        switch (id)
        {
            case 1: return "info";     // Pending
            case 2: return "success";  // Awaiting Ack / Received (tune as needed)
            case 3: return "primary";  // Completed
            case 4: return "danger";   // Rejected
            default: return "info";
        }
    };

    Func<int, string> StatusText = id =>
    {
        return id switch
        {
            1 => isSomali ? "Sugaya" : "Pending",
            2 => isSomali ? "Sugaya Acknowledgement" : "Awaiting Acknowledgement",
            3 => isSomali ? "Dhammaystiran" : "Completed",
            4 => isSomali ? "La Diiday" : "Rejected",
            _ => isSomali ? "Aan La Garan" : "Unknown"
        };
    };
}
<link href="~/css/transfers-index.css" rel="stylesheet" />

<div class="page-header">
    <div>
        <h1 class="page-title" data-tour="tr.title">@Localizer["AssetTransfers"]</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb" data-tour="tr.breadcrumbs">
            <li class="breadcrumb-item">
                <a asp-area="Users" asp-controller="Home" asp-action="Index">@Localizer["Dashboard"]</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Localizer["Transfers"]</li>
        </ol>
    </div>
</div>

<!-- KPI / Summary -->
<div class="row g-3 kpi-row">

    <!-- Outgoing Transfers -->
    <div class="col-md-4 d-flex">
        <!-- add d-flex -->
        <div class="card overflow-hidden kpi-card w-100 h-75 divShadow--xs kpi-link"
             role="link" tabindex="0"
             aria-label="@Localizer["OutgoingTransfers"]"
             data-href="/Users/Transfers/TransferredAssets/@selectedStoreId"
             data-tour="tr.kpi.out">

            <div class="card-status bg-primary br-tr-7 br-tl-7"></div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h4 class="mb-2 fw-semibold">@Localizer["OutgoingTransfers"]</h4>
                        <h3 class="mb-2 fw-semibold">@kpiOutCount.ToString("N0")</h3>
                        <p class="text-muted mb-0 mt-2 fs-6">
                            <span class="fw-semibold">@Localizer["NumberOfAssetsTransferred"]:</span>
                            @kpiOutAssetsCount
                        </p>
                    </div>
                    <div class="col col-auto top-icn dash">
                        <div class="counter-icon bg-primary dash ms-auto box-shadow-primary">
                            <i class="fe fe-upload fs-3 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incoming Transfers -->
    <div class="col-md-4 d-flex">
        <div class="card overflow-hidden kpi-card w-100 h-75 divShadow--xs kpi-link"
             role="link" tabindex="0"
             aria-label="@Localizer["IncomingTransfers"]"
             data-href="/Users/Transfers/ReceivedAssets/@selectedStoreId"
             data-tour="tr.kpi.in">

            <div class="card-status bg-success br-tr-7 br-tl-7"></div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h4 class="mb-2 fw-semibold">@Localizer["IncomingTransfers"]</h4>
                        <h3 class="mb-2 fw-semibold">@kpiInCount.ToString("N0")</h3>
                        <p class="text-muted mb-0 mt-2 fs-6">
                            <span class="fw-semibold">@Localizer["NumberOfAssetsReceived"]:</span>
                            @kpiInAssetsCount
                        </p>
                    </div>
                    <div class="col col-auto top-icn dash">
                        <div class="counter-icon bg-success dash ms-auto box-shadow-success">
                            <i class="fe fe-download fs-3 text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Center -->
    <div class="col-md-4 d-flex">
        <div class="card overflow-hidden kpi-card w-100 h-75 divShadow--xs" data-tour="tr.kpi.actioncenter">
            <div class="card-status bg-secondary br-tr-7 br-tl-7"></div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <h4 class="mb-2 fw-semibold">@Localizer["AttentionRequired"]</h4>
                        <h3 class="mb-2 fw-semibold">@Model?.TotalPendingAck</h3>
                        <p class="text-muted mb-0 mt-2 fs-6">
                            <span class="fw-semibold">@Localizer["AwaitingAcknowledgement"]</span>
                        </p>
                    </div>
                    <div class="col col-auto top-icn dash">
                        <div class="counter-icon bg-secondary dash ms-auto box-shadow-secondary">
                            <i class="fa fa-bell text-white"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>


<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body project-list-table-container">
                <!-- Toolbar -->
                <div class="toolbar d-flex align-items-center gap-2 flex-wrap mb-2" data-tour="tr.toolbar">

                    @if (Model?.IsAuthorized == true)
                    {
                        <a asp-area="Users" asp-controller="Transfers" asp-action="CreateTransfer"
                           class="btn btn-outline-info" data-tour="tr.create"
                           title="@Localizer["NewTransfer"]">
                            <i class="fa fa-circle-plus" aria-hidden="true"></i>
                            <span>@Localizer["NewTransfer"]</span>
                        </a>
                    }

                    <div class="filters-group d-flex align-items-center ms-auto gap-2 flex-wrap" data-tour="tr.filters">
                        <label class="mb-0 fw-semibold" data-tour="tr.filters.label">@Localizer["Filter"]:</label>

                        <!-- Store filter: fixed visual width; Select2 will respect it -->
                        <select id="ddStores"
                                class="form-select select2"
                                data-width="style"
                                style="width: 360px;"
                                data-tour="tr.filters.store"
                                asp-items="storesSelect">
                        </select>

                        <input id="dtFrom" type="text" class="form-control filter-input picker"
                               placeholder="@Localizer["From"]" data-tour="tr.filters.from" />
                        <input id="dtTo" type="text" class="form-control filter-input picker"
                               placeholder="@Localizer["To"]" data-tour="tr.filters.to" />

                        <button id="btnApplyFilters" class="btn btn-outline-primary flex-shrink-0" data-tour="tr.filters.apply">
                            <i class="fe fe-filter"></i> @Localizer["Apply"]
                        </button>
                    </div>
                </div>

                <!-- Outgoing -->
                <div class="mb-3">
                    <h5 class="mb-2" data-tour="tr.out.title">@Localizer["OutgoingFromStore"] (@selectedStoreName)</h5>
                    <div class="table-responsive export-table" data-tour="tr.out.wrap">
                        <table id="tblTransfersOut"
                               class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main"
                               data-tour="tr.out.table">
                            <thead class="bg-primary-gradient ms-auto divShadow" data-tour="tr.out.head">
                                <tr>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["TransferNo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Date"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["StoreTo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Assets"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Status"]</th>
                                </tr>
                            </thead>
                            <tbody class="table-body" data-tour="tr.out.body">
                                @if (Model?.OutgoingTransfers != null)
                                {
                                    foreach (var t in Model.OutgoingTransfers)
                                    {
                                        var statusId = t.TransferStatusId;
                                        var badge = BadgeByStatusId(statusId);
                                        var badgeBgClass = $"bg-{badge}-transparent";
                                        var badgeTextClass = $"text-{badge}";
                                        <tr data-id="@t.Id"
                                            data-status-id="@(t.TransferStatusId)"
                                            data-transfer-date="@t.TransferDate?.ToString("yyyy-MM-dd")">
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferNumber</td>
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferDate?.ToString("dd-MMM-yyyy")</td>
                                            <td class="text-muted fs-15 fw-semibold">@((isSomali ? t.StoreToSo : t.StoreTo) ?? "")</td>
                                            <td class="text-muted fs-15 fw-semibold">@Html.Raw(Model.GetAssetsBadges(t.Id))</td>
                                            <td class="text-muted fs-15 fw-semibold">
                                                <span class="mb-0 mt-1 badge rounded-pill @badgeBgClass @badgeTextClass">
                                                    @StatusText(statusId)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Incoming -->
                <div>
                    <h5 class="mb-2" data-tour="tr.in.title">@Localizer["IncomingToStore"] (@selectedStoreName)</h5>
                    <div class="table-responsive export-table" data-tour="tr.in.wrap">
                        <table id="tblTransfersIn"
                               class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main"
                               data-tour="tr.in.table">
                            <thead class="bg-primary-gradient ms-auto divShadow" data-tour="tr.in.head">
                                <tr>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["TransferNo"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Date"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["StoreFrom"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Assets"]</th>
                                    <th class="text-white bg-transparent border-bottom-0">@Localizer["Status"]</th>
                                </tr>
                            </thead>
                            <tbody class="table-body" data-tour="tr.in.body">
                                @if (Model?.IncomingTransfers != null)
                                {
                                    foreach (var t in Model.IncomingTransfers)
                                    {
                                        var statusId = t.TransferStatusId;
                                        var badge = BadgeByStatusId(statusId);
                                        var badgeBgClass = $"bg-{badge}-transparent";
                                        var badgeTextClass = $"text-{badge}";
                                        <tr data-id="@t.Id"
                                            data-status-id="@(statusId)"
                                            data-transfer-date="@t.TransferDate?.ToString("yyyy-MM-dd")">
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferNumber</td>
                                            <td class="text-muted fs-15 fw-semibold">@t.TransferDate?.ToString("dd-MMM-yyyy")</td>
                                            <td class="text-muted fs-15 fw-semibold">@((isSomali ? t.StoreFromSo : t.StoreFrom) ?? "")</td>
                                            <td class="text-muted fs-15 fw-semibold">@Html.Raw(Model.GetAssetsBadges(t.Id))</td>
                                            <td class="text-muted fs-15 fw-semibold">
                                                <span class="mb-0 mt-1 badge rounded-pill @badgeBgClass @badgeTextClass">
                                                    @StatusText(statusId)
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-sm-12">
                        <a asp-area="Users" asp-controller="Transfers" asp-action="Index" id="btnBack"
                           class="btn btn-outline-default" data-tour="tr.back">
                            <i class="fe fe-corner-up-left"></i>&nbsp;@Localizer["Previous"]
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@await Html.PartialAsync("~/Views/Shared/_Confirmation.cshtml")

@section scripts {
    <partial name="_DatatablesAssets" />

    <script>
        window.TRANSFERS_PAGE = {
            isAuthorized: @Html.Raw((Model?.IsAuthorized ?? false).ToString().ToLowerInvariant()),
            strings: {
                previewTransfer: "@Localizer["PreviewTransfer"]",
                editTransfer: "@Localizer["EditTransfer"]",
                deleteTransfer: "@Localizer["DeleteTransfer"]",
                deleteConfirmationMessage: "@Localizer["DeleteConfirmationMessage"]",
                confirm: "@Localizer["Confirm"]",
                cancel: "@Localizer["Cancel"]",
                date: "@Localizer["Date"]",
                storeFrom: "@Localizer["FromStore"]",
                storeTo: "@Localizer["ToStore"]",
                assets: "@Localizer["Assets"]",
                status: "@Localizer["Status"]"
            }
        };
    </script>

    <script src="~/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="~/js/pages/users/transfers/transfers-index.js"></script>
}