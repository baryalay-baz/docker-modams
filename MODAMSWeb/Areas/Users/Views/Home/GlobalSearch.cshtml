@using Microsoft.AspNetCore.Mvc.Localization
@using MODAMS.Models.ViewModels.Dto
@inject IViewLocalizer Localizer

@model MODAMS.Models.ViewModels.Dto.GlobalSearchDTO

<link href="~/css/globalsearch.css" rel="stylesheet" />

@functions {
    // returns hit-exact | hit-prefix | hit-contains | ""
    string MatchClass(int exactMask, int prefixMask, int containsMask, AssetMatch flag)
    {
        int f = (int)flag;
        if ((exactMask & f) != 0) return "hit-exact";
        if ((prefixMask & f) != 0) return "hit-prefix";
        if ((containsMask & f) != 0) return "hit-contains";
        return string.Empty;
    }

    string MatchTitle(int exactMask, int prefixMask, int containsMask, AssetMatch flag)
    {
        int f = (int)flag;
        if ((exactMask & f) != 0) return "Matched: exact";
        if ((prefixMask & f) != 0) return "Matched: starts with";
        if ((containsMask & f) != 0) return "Matched: contains";
        return "";
    }
}

<div class="page-header">
    <div>
        <h1 class="page-title">@Localizer["SearchAssets"]</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-area="Users" asp-controller="Home" asp-action="Index">@Localizer["Dashboard"]</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Localizer["GlobalSearch"]</li>
        </ol>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card divShadow">
            <div class="card-body p-4">
                <div class="d-flex align-items-center justify-content-between">
                    <h4 class="m-0">@Localizer["AssetsFromAllStores"]</h4>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                @if (Model.Assets != null && Model.Assets.Count > 0)
                {
                    var total = Model.Assets?.Count ?? 0;
                    var noun = total == 1 ? "Asset" : "Assets";

                    <div class="d-flex align-items-center justify-content-between mb-3" aria-live="polite">
                        <span class="badge rounded-pill text-bg-light border fw-semibold py-2 px-3">
                            <i class="bi bi-box-seam me-1" aria-hidden="true"></i>
                            @total.ToString("N0") @noun found
                        </span>
                        @* <span class="text-muted small">Sorted by: Name • Showing page 1</span> *@
                    </div>

                    <div class="row g-3 asset-grid">
                        @foreach (var item in Model.Assets)
                        {
                            var imgUrl = !string.IsNullOrWhiteSpace(item.AssetPicture)
                            ? item.AssetPicture
                            : "/assets/images/placeholders/pictureplaceholder.png";

                            <div class="col-12 col-sm-6 col-lg-4">
                                <div class="card h-100 shadow-sm asset-card">
                                    <div class="asset-thumb">
                                        <img src="@imgUrl" alt="Asset picture" class="asset-img" loading="lazy">
                                        <span class="asset-chip fw-bold">@item.StoreName</span>
                                    </div>

                                    <div class="card-body d-flex flex-column">
                                        @* Category / Subcategory badges with match outline *@
                                        <div class="d-flex align-items-center gap-2 mb-1 small text-muted">
                                            @{
                                                var catClass = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Cat);
                                                var subClass = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Sub);
                                            }
                                            <span class="badge bg-light text-dark text-bold border @catClass"
                                                  title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Cat)">
                                                @item.Category
                                            </span>
                                            <span class="text-secondary">/</span>
                                            <span class="badge bg-secondary-subtle text-bold text-secondary @subClass"
                                                  title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Sub)">
                                                @item.SubCategory
                                            </span>
                                        </div>

                                        @* Name, Make, Model — subtle underline if matched *@
                                        <h5 class="card-title mb-1">
                                            <span class="text-chip @MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Name)"
                                                  title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Name)">
                                                @item.Name
                                            </span>
                                        </h5>

                                        <div class="text-muted mb-2">
                                            <span class="text-chip @MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Make)"
                                                  title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Make)">
                                                @item.Make
                                            </span>
                                            -
                                            <span class="text-chip @MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Model)"
                                                  title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Model)">
                                                @item.Model
                                            </span>
                                        </div>

                                        @if (!string.IsNullOrWhiteSpace(item.Specifications))
                                        {
                                            <p class="card-text clamp-3 mb-3">@item.Specifications</p>
                                        }

                                        <div class="id-grid small">
                                            @if (!string.IsNullOrWhiteSpace(item.Barcode))
                                            {
                                                var cls = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Barcode);
                                                <div class="id-row @cls"
                                                     title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Barcode)">
                                                    <span class="id-label">Barcode</span>
                                                    <code class="id-value" title="@item.Barcode">@item.Barcode</code>
                                                </div>
                                            }
                                            @if (!string.IsNullOrWhiteSpace(item.SerialNo))
                                            {
                                                var cls = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Serial);
                                                <div class="id-row @cls"
                                                     title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Serial)">
                                                    <span class="id-label">Serial</span>
                                                    <code class="id-value" title="@item.SerialNo">@item.SerialNo</code>
                                                </div>
                                            }

                                            @* Vehicles only *@
                                            @if (item.IsVehicle && !string.IsNullOrWhiteSpace(item.Plate))
                                            {
                                                var cls = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Plate);
                                                <div class="id-row @cls"
                                                     title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Plate)">
                                                    <span class="id-label">Plate</span>
                                                    <code class="id-value" title="@item.Plate">@item.Plate</code>
                                                </div>
                                            }
                                            @if (item.IsVehicle && !string.IsNullOrWhiteSpace(item.Engine))
                                            {
                                                var cls = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Engine);
                                                <div class="id-row @cls"
                                                     title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Engine)">
                                                    <span class="id-label">Engine</span>
                                                    <code class="id-value" title="@item.Engine">@item.Engine</code>
                                                </div>
                                            }
                                            @if (item.IsVehicle && !string.IsNullOrWhiteSpace(item.Chasis))
                                            {
                                                var cls = MatchClass(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Chasis);
                                                <div class="id-row @cls"
                                                     title="@MatchTitle(item.MatchExactMask, item.MatchPrefixMask, item.MatchContainsMask, AssetMatch.Chasis)">
                                                    <span class="id-label">Chassis</span>
                                                    <code class="id-value" title="@item.Chasis">@item.Chasis</code>
                                                </div>
                                            }
                                        </div>

                                        <div class="mt-auto pt-2">
                                            <a class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2"
                                               href="/Users/Assets/AssetInfo/@item.Id">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16" aria-hidden="true">
                                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"></path>
                                                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"></path>
                                                </svg>
                                                Asset Details
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-5">No assets found.</div>
                }
            </div>
        </div>
    </div>
</div>