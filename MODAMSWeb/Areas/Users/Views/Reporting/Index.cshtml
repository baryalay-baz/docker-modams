@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@using Newtonsoft.Json
@inject IViewLocalizer Localizer

@model MODAMS.Models.ViewModels.Dto.ReportingDTO

@{
    ViewData["TourPageKey"] = "Reporting/Index";
    bool _isSomali = CultureInfo.CurrentUICulture.Name == "so";
    // Use your existing store from the model (as you prefer)
    var defaultStoreId = Model?.AssetStoreId ?? 0;
}

<link href="~/css/reporting-index.css" rel="stylesheet" />

<div class="page-header">
    <div>
        <h1 class="page-title" data-tour="rp.title">@Localizer["Reports"]</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb" data-tour="rp.breadcrumbs">
            <li class="breadcrumb-item">
                <a asp-area="Users" asp-controller="Home" asp-action="Index">@Localizer["Dashboard"]</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@Localizer["Reports"]</li>
        </ol>
    </div>
</div>

<div class="rp-wrapper" data-tour="rp.layout">
    <div class="row g-3">
        <!-- ===== LEFT: Catalog + Filters + Actions ===== -->
        <div class="col-lg-5">
            <div class="card h-100" data-tour="rp.left">
                <div class="card-body rp-left">
                    <!-- Catalog -->
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <h5 class="mb-0">@Localizer["ReportCatalog"]</h5>
                        <input type="search" class="form-control form-control-sm w-auto" id="rp-search"
                               placeholder="@Localizer["SearchReports"]" data-tour="rp.search" />
                    </div>

                    <div class="row g-2 mb-3" id="rp-catalog">
                        <div class="col-6">
                            <button type="button" class="rp-tile" data-report="asset" data-tour="rp.tile.asset">
                                <i class="bi bi-archive rp-tile__icon" aria-hidden="true"></i>
                                <span class="rp-tile__title">@Localizer["Assets"]</span>
                                <span class="rp-tile__subtitle">@Localizer["AssetReport"]</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="rp-tile" data-report="transfer" data-tour="rp.tile.transfer">
                                <i class="bi bi-arrow-left-right rp-tile__icon" aria-hidden="true"></i>
                                <span class="rp-tile__title">@Localizer["Transfers"]</span>
                                <span class="rp-tile__subtitle">@Localizer["TransfersReport"]</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="rp-tile" data-report="disposal" data-tour="rp.tile.disposal">
                                <i class="bi bi-basket3 rp-tile__icon" aria-hidden="true"></i>
                                <span class="rp-tile__title">@Localizer["Disposals"]</span>
                                <span class="rp-tile__subtitle">@Localizer["DisposalReport"]</span>
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="rp-tile" data-report="verification" disabled data-tour="rp.tile.verification">
                                <i class="bi bi-list-check rp-tile__icon" aria-hidden="true"></i>
                                <span class="rp-tile__title">@Localizer["Verifications"]</span>
                                <span class="rp-tile__subtitle text-muted">@Localizer["ComingSoon"]</span>
                            </button>
                        </div>
                    </div>

                    <hr class="my-3">

                    <!-- Header + Presets + Actions (left) -->
                    <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
                        <div>
                            <h6 class="mb-1" id="rp-panel-title" data-tour="rp.panel.title">@Localizer["Assets"]</h6>
                            <div class="rp-presets" id="rp-presets" data-tour="rp.presets">
                                <button type="button" class="btn btn-light btn-sm rp-preset" data-preset="all">@Localizer["All"]</button>
                                <button type="button" class="btn btn-light btn-sm rp-preset" data-preset="byStore">@Localizer["ByStore"]</button>
                                <button type="button" class="btn btn-light btn-sm rp-preset" data-preset="byStatus">@Localizer["ByStatus"]</button>
                            </div>
                        </div>

                        <div class="btn-group mt-1" data-tour="rp.actions">
                            <button type="button" class="btn btn-primary" id="rp-generate" disabled>
                                <i class="fa fa-eye me-1"></i>@Localizer["Preview"]
                            </button>
                            <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split"
                                    data-bs-toggle="dropdown" aria-expanded="false">
                                <span class="visually-hidden">Toggle</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" id="rp-action-menu">
                                <li><a class="dropdown-item" data-action="export-pdf">@Localizer["ExportPDF"]</a></li>
                                <li><a class="dropdown-item" data-action="window">@Localizer["OpenInNewWindow"]</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Filters block (now under catalog, left side) -->
                    <div id="rp-filters" class="rp-filters" data-tour="rp.filters">
                        <!-- Assets (default) -->
                        <form method="get" target="rpPreviewFrame"
                              asp-area="Users" asp-controller="Reporting" asp-action="ReportViewer"
                              id="frmAssetReport" class="rp-form" data-report="asset">
                            <input type="hidden" name="ReportId" value="AssetReport" />
                            <input type="hidden" name="Mode" value="Window" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="AssetStoreId" class="form-label"></label>
                                    <select asp-for="AssetStoreId" asp-items="@Model.AssetStores" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStores"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="AssetStatusId" class="form-label"></label>
                                    <select asp-for="AssetStatusId" asp-items="@Model.AssetStatuses" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStatuses"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="CategoryId" class="form-label"></label>
                                    <select asp-for="CategoryId" asp-items="@Model.Categories" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllCategories"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="AssetConditionId" class="form-label"></label>
                                    <select asp-for="AssetConditionId" asp-items="@Model.Conditions" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllConditions"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DonorId" class="form-label"></label>
                                    <select asp-for="DonorId" asp-items="@Model.Donors" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllDonors"]</option>
                                    </select>
                                </div>

                                <!-- NEW: Date range -->
                                <div class="col-md-6">
                                    <label asp-for="DateFrom" class="form-label"></label>
                                    <input asp-for="DateFrom" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DateTo" class="form-label"></label>
                                    <input asp-for="DateTo" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                            </div>
                        </form>

                        <!-- Transfers -->
                        <form method="get" target="rpPreviewFrame"
                              asp-area="Users" asp-controller="Reporting" asp-action="ReportViewer"
                              id="frmTransferReport" class="rp-form d-none" data-report="transfer">
                            <input type="hidden" name="ReportId" value="TransferReport" />
                            <input type="hidden" name="Mode" value="Window" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="StoreFromId" class="form-label"></label>
                                    <select asp-for="StoreFromId" asp-items="@Model.TransferStores" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStores"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="StoreToId" class="form-label"></label>
                                    <select asp-for="StoreToId" asp-items="@Model.TransferStores" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStores"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="TransferStatusId" class="form-label"></label>
                                    <select asp-for="TransferStatusId" asp-items="@Model.TransferStatuses" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStatuses"]</option>
                                    </select>
                                </div>

                                <!-- NEW: Date range -->
                                <div class="col-md-6">
                                    <label asp-for="DateFrom" class="form-label"></label>
                                    <input asp-for="DateFrom" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DateTo" class="form-label"></label>
                                    <input asp-for="DateTo" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                            </div>
                        </form>

                        <!-- Disposals -->
                        <form method="get" target="rpPreviewFrame"
                              asp-area="Users" asp-controller="Reporting" asp-action="ReportViewer"
                              id="frmDisposalReport" class="rp-form d-none" data-report="disposal">
                            <input type="hidden" name="ReportId" value="DisposalReport" />
                            <input type="hidden" name="Mode" value="Window" />
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="DisposalStoreId" class="form-label"></label>
                                    <select asp-for="DisposalStoreId" asp-items="@Model.AssetStores" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllStores"]</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DisposalTypeId" class="form-label"></label>
                                    <select asp-for="DisposalTypeId" asp-items="@Model.DisposalTypes" class="form-control select2" data-all="0">
                                        <option value="0">@Localizer["AllDisposalTypes"]</option>
                                    </select>
                                </div>

                                <!-- NEW: Date range -->
                                <div class="col-md-6">
                                    <label asp-for="DateFrom" class="form-label"></label>
                                    <input asp-for="DateFrom" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="DateTo" class="form-label"></label>
                                    <input asp-for="DateTo" class="form-control picker"
                                           asp-format="{0:dd-MMM-yyyy}" aria-required="true" type="text"
                                           autocomplete="off" />
                                </div>
                            </div>
                        </form>
                    </div>

                    @* <small class="text-muted d-block mt-2" data-tour="rp.tip">
                        @Localizer["TipUsePresetsThenAdjust"]
                    </small> *@
                </div>
            </div>
        </div>

        <!-- ===== RIGHT: Report Viewer only ===== -->
        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-body p-2">
                    <div class="rp-preview h-100">
                        <iframe name="rpPreviewFrame" id="rpPreviewFrame" title="Report Preview" loading="lazy"></iframe>
                        <div id="rpEmpty" class="rp-empty">
                            @(_isSomali ? "Isticmaal sifaynta kadibna guji 'Muuji'." : "Use filters, then click Preview.")
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        window.REPORTING = {
            isSomali: "@(_isSomali ? "true" : "false")",
            // use your existing model store as default
            defaultStoreId: @defaultStoreId,
            i18n: {
                chooseStore: "@(_isSomali ? "Fadlan dooro Bakhaar." : "Please choose a Store.")",
                chooseStatus: "@(_isSomali ? "Fadlan dooro Xaalad." : "Please choose a Status.")"
            }
        };
    </script>
    <script src="~/js/pages/reporting-index.js"></script>
    <script src="~/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
}
