@using Microsoft.AspNetCore.Mvc.Localization
@using System.Globalization
@inject IViewLocalizer Localizer
@model MODAMS.Models.ViewModels.Dto.DisposalsDTO

@{
    ViewData["TourPageKey"] = "Disposals/Index";
    var isSo = CultureInfo.CurrentUICulture.Name == "so";

    var labels = Model?.ChartData?.Select(x => x.Type) ?? Enumerable.Empty<string>();
    var values = Model?.ChartData?.Select(x => x.Count) ?? Enumerable.Empty<int>();

    var kpiTop = Model?.ChartData?.Take(3).ToList() ?? new List<MODAMS.Models.ViewModels.Dto.DisposalChart>();
    var kpiOthers = Math.Max(0, (Model?.ChartData?.Skip(3).Sum(x => x.Count) ?? 0));
}

<link rel="stylesheet" href="~/css/disposals-index.css" />

<div class="page-header">
    <div>
        <h1 class="page-title" data-tour="ds.title">@Localizer["Disposals"]</h1>
    </div>
    <div class="ms-auto pageheader-btn">
        <ol class="breadcrumb" data-tour="ds.breadcrumbs">
            <li class="breadcrumb-item"><a asp-area="Users" asp-controller="Home" asp-action="Index">@Localizer["Dashboard"]</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Localizer["Disposals"]</li>
        </ol>
    </div>
</div>

<!-- KPIs -->
<div class="row g-3 kpi-row" data-tour="ds.kpis">
    @foreach (var item in kpiTop)
    {
        <div class="col-12 col-sm-6 col-xl-3 d-flex">
            <div class="card card-kpi w-100 divShadow--xs">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="kpi-label">@item.Type</div>
                            <div class="kpi-value">@item.Count.ToString("N0")</div>
                        </div>
                        <div class="kpi-icon">
                            <i class="fe fe-archive"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    <div class="col-12 col-sm-6 col-xl-3 d-flex">
        <div class="card card-kpi w-100 divShadow--xs">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="kpi-label">@Localizer["Others"]</div>
                        <div class="kpi-value">@kpiOthers.ToString("N0")</div>
                    </div>
                    <div class="kpi-icon">
                        <i class="fe fe-more-horizontal"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content -->
<div class="row g-3 align-items-stretch">
    <!-- Left: Table -->
    <div class="col-xl-9 d-flex">
        <div class="card flex-grow-1">
            <div class="card-body project-list-table-container">

                <!-- Toolbar -->
                <div class="toolbar d-flex align-items-center flex-wrap gap-2 mb-2" data-tour="ds.toolbar">
                    @if (Model?.IsAuthorized == true)
                    {
                        <a asp-area="Users" asp-controller="Disposals" asp-action="CreateDisposal"
                           class="btn btn-outline-info toolbar__new" data-tour="ds.create"
                           title="@Localizer["NewDisposal"]">
                            <i class="fa fa-circle-plus"></i>
                            <span>@Localizer["NewDisposal"]</span>
                        </a>
                    }

                    <!-- Store chip -->
                    <div class="store-chip text-truncate p-2" title="@Model?.StoreName" data-tour="ds.store">
                        <i class="fe fe-home me-1"></i>
                        <span class="store-chip__text">@Model?.StoreName</span>
                    </div>

                    <div class="toolbar__spacer"></div>


                    <div class="toolbar__filters d-inline-flex align-items-center flex-wrap gap-2">
                        <input id="dtFrom" type="text" class="form-control picker toolbar__input"
                               placeholder="@Localizer["From"]" data-tour="ds.filters.from" />
                        <input id="dtTo" type="text" class="form-control picker toolbar__input"
                               placeholder="@Localizer["To"]" data-tour="ds.filters.to" />
                        <button id="btnApplyFilters" class="btn btn-outline-primary toolbar__apply"
                                data-tour="ds.filters.apply">
                            <i class="fe fe-filter"></i> @Localizer["Apply"]
                        </button>
                    </div>
                </div>

                <div class="table-responsive export-table">
                    <table id="tblDisposals" class="table text-nowrap mb-0 table-bordered border-top border-bottom project-list-main" data-tour="ds.table">
                        <thead class="table-head divShadow">
                            <tr>
                                <th class="border-bottom-0 w-5">@Localizer["SNo"]</th>
                                <th class="border-bottom-0 w-10">@Localizer["Date"]</th>
                                <th class="border-bottom-0 w-14">@Localizer["DisposalType"]</th>
                                <th class="border-bottom-0 w-28">@Localizer["AssetName"]</th>
                                <th class="border-bottom-0 w-18">@Localizer["Identification"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var idx = 0;
                                foreach (var d in Model?.Disposals ?? Enumerable.Empty<MODAMS.Models.Disposal>())
                                {
                                    idx++;
                                    var sNo = idx < 10 ? "0" + idx : idx.ToString();
                                    var isVehicle = d.Asset?.SubCategory?.Category?.CategoryName == "Vehicles";
                                    var ident = isVehicle
                                    ? (isSo ? "Taarikada: " : "Plate No: ") + (d.Asset?.Plate ?? "-")
                                    : (isSo ? "Sereelka: " : "SN: ") + (d.Asset?.SerialNo ?? "-");

                                    // IMPORTANT: stable ISO date attribute for client-side filtering
                                    <tr data-id="@d.Id" data-date="@d.DisposalDate.ToString("yyyy-MM-dd")">
                                        <td class="text-muted fs-15 fw-semibold">@sNo</td>
                                        <td class="text-muted fs-15 fw-semibold">@d.DisposalDate.ToString("dd-MMM-yyyy")</td>
                                        <td class="text-muted fs-15 fw-semibold">@((isSo ? d.DisposalType?.TypeSo : d.DisposalType?.Type) ?? "-")</td>
                                        <td class="text-muted fs-15 fw-semibold">@d.Asset?.Name</td>
                                        <td class="text-muted fs-15 fw-semibold">@ident</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <!-- Right: Donut -->
    <div class="col-xl-3 d-flex">
        <div class="card flex-grow-1">
            <div class="card-header"><div class="card-title mb-0">@Localizer["ByType"]</div></div>
            <div class="card-body d-flex justify-content-center align-items-center">
                <canvas id="pieChartDisposals" width="260" height="260" data-tour="ds.chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
@await Html.PartialAsync("~/Views/Shared/_Confirmation.cshtml")
<div class="modal fade" id="mdlPreviewDisposal" tabindex="-1" aria-labelledby="mdlPreviewDisposalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mdlPreviewDisposalLabel"><i class="bi bi-eye-fill me-1"></i>@Localizer["PreviewDisposal"]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="row g-2">
                            <div class="col-sm-6">
                                <label class="form-label">@Localizer["DepartmentName"]</label>
                                <input id="txtDepartmentName" class="form-control" readonly />
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label">@Localizer["DisposalType"]</label>
                                <input id="txtDisposalType" class="form-control" readonly />
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label">@Localizer["SubCategoryName"]</label>
                                <input id="txtSubCategoryName" class="form-control" readonly />
                            </div>
                            <div class="col-sm-6">
                                <label class="form-label">@Localizer["AssetName"]</label>
                                <input id="txtAssetName" class="form-control" readonly />
                            </div>
                            <div class="col-12">
                                <label class="form-label">@Localizer["Identification"]</label>
                                <input id="txtIdentification" class="form-control" readonly />
                            </div>
                            <div class="col-12">
                                <label class="form-label">@Localizer["DisposalNotes"]</label>
                                <textarea id="txtDisposalNotes" class="form-control" style="height:120px" readonly></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 d-flex align-items-center justify-content-center">
                        <figure class="photo-frame">
                            <img id="imgDisposalPreview"
                                 src="/assets/images/placeholders/pictureplaceholder.jpg"
                                 alt=""
                                 class="photo-frame__img" />
                            <figcaption class="photo-frame__cap">@Localizer["DisposalImage"]</figcaption>
                        </figure>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Close"]</button></div>
        </div>
    </div>
</div>

@section scripts {
    <partial name="_DatatablesAssets" />
    <partial name="_ChartAssets" />
    <script>
        window.DISPOSALS_PAGE = {
            isAuthorized: @Html.Raw((Model?.IsAuthorized ?? false).ToString().ToLowerInvariant()),
            strings: {
                deleteTitle: "@Localizer["DeleteDisposal"]",
                deleteMessage: "@Localizer["DeleteConfirmationMessage"]",
                confirm: "@Localizer["Confirm"]",
                cancel: "@Localizer["Cancel"]"
            },
            labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(labels)),
            values: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(values))
        };
    </script>
    <script src="~/assets/plugins/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="~/js/pages/disposals-index.js"></script>
}
